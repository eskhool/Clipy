fastlane_version "2.71.0"

default_platform :mac

platform :mac do

  ############################ PRE ############################

  before_all do
  end

  ####################### PUBLIC LANES ########################

  desc "Runs all the tests"
  lane :test do
    slack(message: "Start Testing")
    scan
    slack(message: "Passed All Tests")
  end

  desc "Release"
  lane :release do
    # Check Xcode Version
    xcversion(version: "9.2")
    # Check Git Status is Clean
    ensure_git_status_clean
    # Build Clipy.app
    gym(
      xcargs: "CODE_SIGN_IDENTITY='Developer ID Application: Shunsuke Furubayashi (BBCHAJ584H)' DEVELOPMENT_TEAM='BBCHAJ584H'",
      export_options: {
        provisioningProfiles: {
          "com.clipy-app.Clipy" => "ClipyDistribution2"
        }
      }
    )
  end

  ####################### PRIVATE LANES ########################

  ############################ POST ############################

  after_all do |lane|
  end

  error do |lane, exception|
    if lane == :scan_clipy
      slack(
        message: "Failed Tests: " + ENV['FL_REPORT_PATH'],
        success: false
      )
    end
  end
end
